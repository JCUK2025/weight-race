// Storage Key V14 for fresh logic
let users = JSON.parse(localStorage.getItem('holiday_v14')) || [
    {id:1, name:"Lisa", color:"#e84393", logs:[], h:0, target:0, tDate:""},
    {id:2, name:"John", color:"#2d3436", logs:[], h:0, target:0, tDate:""}
];
let currentId = users.length ? users[0].id : null;
let unit = localStorage.getItem('race_unit') || 'kg';

function saveAll() { 
    localStorage.setItem('holiday_v14', JSON.stringify(users)); 
    localStorage.setItem('race_unit', unit); 
}

// TAB SWITCHER: Forcefully reloads data into inputs
function switchUser(id) {
    // Find user; guard if not found
    const candidate = users.find(x => x.id === id);
    if (!candidate) {
        // fallback: choose first user if available
        if (users.length) {
            currentId = users[0].id;
        } else {
            currentId = null;
        }
        render(); // clear UI
        return;
    }
    currentId = candidate.id;
    const u = candidate;
    
    // Sync UI Inputs
    document.getElementById('in_name').value = u.name || "";
    document.getElementById('in_color').value = u.color || "#6c5ce7";
    document.documentElement.style.setProperty('--active-color', u.color || "#6c5ce7");
    
    // Load Height
    if(unit === 'kg') {
        document.getElementById('h_cm').value = u.h ? u.h : "";
        document.getElementById('h_ft').value = "";
        document.getElementById('h_in').value = "";
    } else {
        if (u.h && u.h > 0) {
            const ft = Math.floor(u.h / 30.48);
            const inch = Math.round((u.h - (ft * 30.48)) / 2.54);
            document.getElementById('h_ft').value = ft;
            document.getElementById('h_in').value = inch;
        } else {
            document.getElementById('h_ft').value = "";
            document.getElementById('h_in').value = "";
        }
        document.getElementById('h_cm').value = "";
    }

    // Load Target
    if(u.target && u.target > 0) {
        if(unit === 'kg') {
            document.getElementById('t_kg').value = Number(u.target).toFixed(1);
            document.getElementById('t_st').value = "";
            document.getElementById('t_lb').value = "";
        } else {
            const lbs = u.target * 2.20462;
            document.getElementById('t_st').value = Math.floor(lbs/14);
            document.getElementById('t_lb').value = +(lbs % 14).toFixed(1);
            document.getElementById('t_kg').value = "";
        }
    } else {
        document.getElementById('t_kg').value = "";
        document.getElementById('t_st').value = "";
        document.getElementById('t_lb').value = "";
    }
    document.getElementById('t_date').value = u.tDate || "";

    // Clear any weight input leftover
    document.getElementById('w_kg').value = "";
    document.getElementById('w_st').value = "";
    document.getElementById('w_lb').value = "";

    render();
}

function updateUserProfile() {
    const u = users.find(x => x.id === currentId);
    if (!u) return;
    u.name = document.getElementById('in_name').value || u.name;
    u.color = document.getElementById('in_color').value || u.color;
    if(unit === 'kg') {
        const parsed = parseFloat(document.getElementById('h_cm').value);
        u.h = isFinite(parsed) ? parsed : (u.h || 0);
    } else {
        const ft = parseFloat(document.getElementById('h_ft').value) || 0;
        const inch = parseFloat(document.getElementById('h_in').value) || 0;
        const calc = (ft * 30.48) + (inch * 2.54);
        u.h = isFinite(calc) ? calc : (u.h || 0);
    }
    saveAll();
    render();
}

function updateUserGoal() {
    const u = users.find(x => x.id === currentId);
    if (!u) return;
    if(unit === 'kg') {
        const parsed = parseFloat(document.getElementById('t_kg').value);
        u.target = isFinite(parsed) ? parsed : 0;
    } else {
        const st = parseFloat(document.getElementById('t_st').value) || 0;
        const lb = parseFloat(document.getElementById('t_lb').value) || 0;
        const lbs = (st * 14) + lb;
        const kg = isFinite(lbs) ? (lbs / 2.20462) : 0;
        u.target = kg || 0;
    }
    u.tDate = document.getElementById('t_date').value || "";
    saveAll();
    render();
}

function addWeightEntry() {
    const u = users.find(x => x.id === currentId);
    if (!u) return;
    let kg = NaN;
    if(unit === 'kg') {
        kg = parseFloat(document.getElementById('w_kg').value);
    } else {
        const st = parseFloat(document.getElementById('w_st').value) || 0;
        const lb = parseFloat(document.getElementById('w_lb').value) || 0;
        const lbs = (st * 14) + lb;
        kg = lbs / 2.20462;
    }
    if(!isFinite(kg) || kg <= 0) return;
    // push a snapshot
    u.logs.push({kg: +kg.toFixed(1), d: new Date().toLocaleDateString('en-GB')});
    saveAll();
    render();
    // clear inputs
    document.getElementById('w_kg').value = "";
    document.getElementById('w_st').value = "";
    document.getElementById('w_lb').value = "";
}

function getProg(u) {
    if(!u || !u.logs || u.logs.length === 0 || !u.target || u.target === 0) return 0;
    const startWeight = u.logs[0].kg;
    const currentWeight = u.logs[u.logs.length-1].kg;
    const totalToLose = startWeight - u.target;
    if(totalToLose <= 0) return currentWeight <= u.target ? 100 : 0;
    let p = ((startWeight - currentWeight) / totalToLose) * 100;
    return Math.min(100, Math.max(0, p));
}

function render() {
    // guard current user
    if (!currentId && users.length) currentId = users[0].id;
    const u = users.find(x => x.id === currentId);

    // Render Tabs
    document.getElementById('user-tabs').innerHTML = users.map(usr => `
        <button class="user-btn ${usr.id===currentId?'active':''}" 
                style="background:${usr.color}" 
                onclick="switchUser(${usr.id})">${usr.name}</button>
    `).join('') + `<button class="add-btn" onclick="addNewUser()">+</button>`;

    // Toggle Units
    ['h','w','t'].forEach(p => {
        const metric = document.getElementById(p+'-metric');
        const imp = document.getElementById(p+'-imp');
        if (metric && imp) {
            metric.classList.toggle('hidden', unit !== 'kg');
            imp.classList.toggle('hidden', unit === 'kg');
        }
    });

    // Reset stats to defaults to avoid leftover data
    document.getElementById('val-bmi').innerText = "--";
    document.getElementById('val-left').innerText = "Set Target";
    document.getElementById('val-weekly').innerText = "--";

    // Update stats for current user if possible
    if (u) {
        if(u.logs.length > 0) {
            const curKg = u.logs[u.logs.length-1].kg || 0;
            document.getElementById('val-bmi').innerText = (u.h > 0) ? (curKg / ((u.h/100)**2)).toFixed(1) : "--";
            
            if(u.target && u.target > 0) {
                const diff = curKg - u.target;
                document.getElementById('val-left').innerText = diff > 0 ? formatW(diff) : "GOAL HIT! ðŸ¹";
                
                if(u.tDate && diff > 0) {
                    const weeks = (new Date(u.tDate) - new Date()) / (1000*60*60*24*7);
                    document.getElementById('val-weekly').innerText = weeks > 0 ? formatW(diff/weeks) : "Past Holiday Date";
                } else {
                    document.getElementById('val-weekly').innerText = "--";
                }
            } else {
                document.getElementById('val-left').innerText = "Set Target";
                document.getElementById('val-weekly').innerText = "--";
            }
        } else {
            // No logs: show "No weight logged" style text
            document.getElementById('val-bmi').innerText = "--";
            document.getElementById('val-left').innerText = u.target && u.target > 0 ? "No weight logged" : "Set Target";
            document.getElementById('val-weekly').innerText = "--";
        }
    }

    // Group Total
    let totalLost = 0;
    users.forEach(usr => { if(usr.logs && usr.logs.length > 1) totalLost += (usr.logs[0].kg - usr.logs[usr.logs.length-1].kg); });
    document.getElementById('group-total-val').innerText = formatW(totalLost);

    // Race Page
    const sorted = [...users].sort((a,b) => getProg(b) - getProg(a));
    document.getElementById('race-container').innerHTML = sorted.map(usr => `
        <div class="card">
            <div style="display:flex;justify-content:space-between;font-size:12px;font-weight:bold;margin-bottom:5px;">
                <span>${usr.name}</span>
                <span>${getProg(usr).toFixed(1)}%</span>
            </div>
            <div style="background:#eee; height:12px; border-radius:10px; overflow:hidden;">
                <div style="width:${getProg(usr)}%; height:100%; background:${usr.color}; transition:0.5s;"></div>
            </div>
        </div>
    `).join('');
}

function formatW(kg) {
    if(!isFinite(kg)) kg = 0;
    if(unit === 'kg') return kg.toFixed(1) + 'kg';
    const lbs = kg * 2.20462;
    return Math.floor(lbs/14) + 'st ' + (lbs%14).toFixed(1) + 'lb';
}

function changeUnit(u) { unit = u; saveAll(); switchUser(currentId); }
function addNewUser() { const n = {id:Date.now(), name:"Racer", color:"#0984e3", logs:[], h:0, target:0, tDate:""}; users.push(n); saveAll(); switchUser(n.id); }
function deleteCurrentUser() { 
    if(!currentId) return;
    if(confirm("Erase all data for this person?")) { 
        const u = users.find(x => x.id === currentId);
        if (!u) return;
        u.logs=[];
        u.target=0;
        u.tDate="";
        saveAll(); 
        switchUser(currentId); 
    } 
}
function showPage(p) {
    document.querySelectorAll('.page').forEach(pg => pg.classList.toggle('hidden', pg.id !== 'page-'+p));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('btn-'+p).classList.add('active');
}

// Initial Load
render();
if (currentId) switchUser(currentId);
